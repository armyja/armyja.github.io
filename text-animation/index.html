<!DOCTYPE html>
<html>
  <header>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      .background {
        width: 500px;
        background-color: brown;
        padding: 10px;
      }

      .text {
        color: #fff;
      }

      .animation-text-wipe {
        -webkit-mask-image: linear-gradient(
          to right,
          #fff 0%,
          transparent 1% 50%,
          #fff 50% 100%
        );
        -webkit-mask-size: 400%;
        -webkit-mask-position: -33%;

        animation-name: text-wipe;
        animation-duration: 1.6s;
        animation-timing-function: linear;
        animation-iteration-count: 1;
        animation-fill-mode: forwards;
      }
      @keyframes text-wipe {
        0% {
          -webkit-mask-position: 2%;
        }
        100% {
          -webkit-mask-position: -33%;
        }
      }
    </style>
  </header>
  <body>
    <div class="background">
      <div id="empty" class="text"></div>
    </div>
    <br />
    <button id="btn" onclick="generate()">生成</button>
    <button id="btn1" onclick="skip()">跳过</button>
    <button id="btn2" onclick="clearText()">清空</button>
    <br />
    <br />
    <textarea id="content" style="width: 500px; height: 100vh">
        长歌行
        作者：李白
        
        桃李待日开，荣华照当年。
        东风动百物，草木尽欲言。
        枯枝无丑叶，涸水吐清泉。
        大力运天地，羲和无停鞭。
        功名不早著，竹帛将何宣。
        桃李务青春，谁能贯白日。
        富贵与神仙，蹉跎成两失。
        金石犹销铄，风霜无久质。
        畏落日月后，强欢歌与酒。
        秋霜不惜人，倏忽侵蒲柳

        桃李盛开的日子，荣华灿烂照耀当年。春风吹动万物，大地上处处充满了蓬勃的生机，草木都意欲彰显自己最美的一面。在这万物复苏的季节，枯枝上不会长出丑叶，干涸之水也会吐出清泉。天地万物都跟随大自然的运转，太阳公羲和没有停鞭休息的时候。如果功名不早著，自己的功勋怎会彪炳史册呢？桃李开时须是春天，谁能让白天悄悄流逝，而期望它能再次回来？富贵与神仙，两者是不能同时得到的，再蹉跎下去二者都会以失败而告终。金石尚且能够销铄，风霜尚且没有固定的品质，何况是人呢？害怕等到日下月落之后，只会在歌与酒之间强颜欢笑，蹉跎时光。秋霜是不会等人的，突然之间蒲树与柳树的叶子就凋落了。

        诗用浪漫手法开始，前四句谈自己生平的抱负：或者做个安期生那样的神仙，游戏人生；要么做个李西平那样的名将，杀敌立功。这四句写得气势很雄壮，与李白《将进酒》等古风一样，给人以一种强烈的激励，使人进入振奋的状态。就表达上来说，前者又只是后者的陪衬，做神仙是幻想，做名将才是诗人努力想实现的方向。同时，用李西平事又十分贴切当时时局，陆游正是想要同李西平扫平逆贼、收复旧京长安一样扫平金虏、收复旧都汴京。

　　然而，现实是残酷无情的，愿望是那么地虚无缥缈。诗人回到了现实，便把前四句放出的狂澜一下子倒挽回来，进而感叹自己，年龄老大，功业无成，只能闲居在僧寮，无聊地躺着，默送着夕阳西下。他想着，像自己这样的战士，就不能只作个诗人，发出凄苦的吟声，这决不是自己所愿意的，于是诗在沉重的压抑中再度放开，故作豪语，先写自己放浪于酒，意气奋发，从而在吐露心中郁结的烦闷时，又表现自己的豪情、对未来的向往，这就是收复失地，饮酒庆功。末两句结得很自然，既承上饮酒而来，又与起首要做李西平遥遥呼应。

　　后人评放翁诗十九都是从军之作，这首诗虽然是闲居遣怀，主题仍与从军诗保持了一致。诗的格调雄放豪轶，悲中带壮，既有不满与牢骚，又充满积极向上的奋斗精神，无论是醉歌作达还是自我排遣，都紧密围绕对国事的关心与对未来的信心，所以很有鼓舞力。
    </textarea>
    <script>
      function getTextWidth(text, font) {
        const canvas =
          getTextWidth.canvas ||
          (getTextWidth.canvas = document.createElement("canvas"));
        const context = canvas.getContext("2d");
        context.font = font;
        const metrics = context.measureText(text);
        return metrics.width;
      }
      let flag = false;
      let timeoutFn = null;
      let interval = 1600;
      const arr = [];
      function clearText() {
        arr.splice(0, arr.length);
        const container = document.querySelector(".background");
        while (container.lastElementChild !== container.firstElementChild) {
          container.removeChild(container.lastElementChild);
        }
      }
      function skip() {
        if (arr.length === 0) {
          return;
        }
        flag = true;
        let last = document.querySelectorAll(".animation-text-wipe");
        last[last.length - 1].classList.remove("animation-text-wipe");
        clearTimeout(timeoutFn);
        fn();
      }
      let fn = (time) =>
        setTimeout(() => {
          if (arr.length === 0) {
            return;
          }
          const container = document.querySelector(".background");
          let el = document.createElement("div");
          el.textContent = arr.shift();
          el.classList.add("text");
          if (!flag) {
            el.classList.add("animation-text-wipe");
          }
          container.appendChild(el);
          if (arr.length > 0) {
            timeoutFn = fn(flag ? 0 : interval);
          }
        }, time);
      function generate() {
        if (arr.length > 0) {
          return;
        }
        clearText();
        flag = false;
        const width = getComputedStyle(document.querySelector("#empty")).width;
        const font = getComputedStyle(document.querySelector("#empty")).font;
        const widthNum = parseFloat(width.replace("px", ""));
        const content = document.querySelector("#content").value;
        let prev = 0;
        let i = 0;
        let tmpWidth = 0;
        for (; i < content.length; i++) {
          tmpWidth += getTextWidth(content[i], font);

          if (content[i] === "\n") {
            tmpWidth = 0;
            let c = content.substring(prev, i);
            arr.push(c);
            prev = i + 1;
          }
          if (tmpWidth > widthNum) {
            tmpWidth = getTextWidth(content[i], font);

            let c = content.substring(prev, i);
            arr.push(c);

            prev = i;
          }
        }
        if (prev < i) {
          arr.push(content.substring(prev, i));
        }

        timeoutFn = fn();
      }
      
      (() => {
        generate();
      })();
    </script>
  </body>
</html>
